# Using the terraform module #

* [Sources](#sources)
* [Setting variables](#setting-variables)
* [Using custom binaries](#using-custom-binaries)
  * [From local file](#from-local-file)
  * [From S3](#from-s3)
* [Multiple instances](#multiple-instances)
* [Uninstall](#uninstall)

## Sources ##

The autospotting module can be used from the Terraform Registry (updated infrequently) or this repository.

You can use the module with prebuilt binaries from the Terraform Registry:

```hcl
module "autospotting" {
  source  = "cristim/autospotting/aws"
  version = "0.0.9" # this version is subject to change
}
```

You can also use the module from this repository, but you'll also need to provide a reference to the autospotting binaries: 

```hcl
module "autospotting" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform?ref=44095c6"

  lambda_zipname = "./lambda.zip"
}
```

Then use the module as you would any other:

```shell
terraform init # fetches required plugin and modules for terraform
export AWS_DEFAULT_REGION=XXXX
export AWS_ACCESS_KEY_ID=XXXX
export AWS_SECRET_ACCESS_KEY=XXXX
terraform plan
terraform apply -auto-approve
```

## Setting variables ##

Available variables are defined in the [variables file](variables.tf). To change the defaults, just pass in the relevant variables:

```hcl
module "autospotting" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform"

  autospotting_regions_enabled          = "eu*,us*"
  autospotting_min_on_demand_percentage = "33.3"

  lambda_zipname     = "./lambda.zip"
  lambda_memory_size = 1024
}
```

Or you can pass them in on the command line:

``` shell
 terraform apply \
   -var autospotting_regions_enabled="eu*,us*" \
   -var autospotting_min_on_demand_percentage="33.3" \
   -var lambda_zipname="./lambda.zip" \
   -var lambda_memory_size=1024
```

Note: due to version differences between the Terraform Registry module and the module in this repository, the available variables might be different.


## Using custom binaries ##

The `lambda.zip` file can be generated by building it locally using `make` (then look for it in the `build` directory), but you'll need to set up your local development environment.

Instead, you can also download the latest official nightly build available [here](https://cloudprowess.s3.amazonaws.com/nightly/lambda.zip).

### From local file ###

If you store the file locally:

```hcl
module "autospotting" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform"

  lambda_zipname = "./lambda.zip"
}
```

### From S3 ###

Instead of using a local ZIP file you can refer to the Lambda code in a location in S3:

```hcl
module "autospotting" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform"

  lambda_s3_bucket = "lambda-releases"
  lambda_s3_key    = "autospotting.zip"
}
```

## Multiple instances ##

You can change the names of the resources terraform will create – or run multiple instances of autospotting that target different ASGs – by using the label variables:

```hcl
module "autospotting_storage" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform"

  label_name = "autospotting_storage"

  autospotting_allowed_instance_types = "i3.*"
  autospotting_tag_filters            = "spot-enabled=true,storage-optimized=true,"

  lambda_zipname = "./lambda.zip"
}

module "autospotting_dev_memory" {
  source = "github.com/AutoSpotting/AutoSpotting//terraform"

  label_name        = "autospotting_memory"
  label_environment = "dev"

  autospotting_allowed_instance_types = "r5*"
  autospotting_tag_filters            = "spot-enabled=true,memory-optimized=true,environment=dev,"

  lambda_zipname = "./lambda.zip"
}
```

## Uninstall ##

Destroy the terraform stack:

```shell
cd terraform
echo "yes" | terraform destroy
```
